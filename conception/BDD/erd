erDiagram
    USER {
        UUID id PK
        VARCHAR email
        TEXT hashed_password
        VARCHAR role
        TIMESTAMP created_at
    }
    GUEST {
        UUID id PK
        VARCHAR email
        TIMESTAMP created_at
    }
    PROJECT {
        UUID id PK
        VARCHAR name
        UUID client_guest_id FK
    }
    DELIVERY {
        UUID id PK
        UUID project_id FK
        VARCHAR title
        VARCHAR version
        UUID issuer_id FK
        TIMESTAMP created_at
    }
    FILE {
        UUID id PK
        VARCHAR storage_key
        VARCHAR filename
        UUID delivery_id FK
        UUID nce_id FK
        TIMESTAMP created_at
    }
    DELIVERY_RECEIPT {
        UUID id PK
        UUID delivery_id FK
        UUID file_id FK
        TIMESTAMP generated_at
    }
    EMAIL_TOKEN {
        UUID id PK
        VARCHAR token
        VARCHAR email
        VARCHAR purpose
        UUID resource_id
        TIMESTAMP expires_at
    }
    SURVEY {
        UUID id PK
        UUID delivery_id FK
        VARCHAR type
        SMALLINT score
        VARCHAR respondent_email
        TIMESTAMP responded_at
    }
    NCE {
        UUID id PK
        UUID delivery_id FK
        VARCHAR title
        TEXT description
        VARCHAR category
        VARCHAR severity
        VARCHAR status
        VARCHAR reporter_email
        TIMESTAMP created_at
    }
    NOTIFICATION {
        UUID id PK
        UUID recipient_id FK
        VARCHAR guest_email
        VARCHAR type
        VARCHAR title
        TEXT message
        BOOLEAN is_read
        TIMESTAMP created_at
    }
    AUDIT_LOG {
        UUID id PK
        VARCHAR entity
        UUID entity_id
        VARCHAR action
        VARCHAR actor_email
        JSONB details
        TIMESTAMP created_at
    }

    USER ||--o{ DELIVERY : issues
    GUEST ||--o{ PROJECT : owns_optional
    PROJECT ||--o{ DELIVERY : contains
    DELIVERY ||--o{ FILE : has
    FILE }o--|| NCE : maybe_related
    DELIVERY ||--o{ DELIVERY_RECEIPT : has
    FILE ||--o{ DELIVERY_RECEIPT : file_of
    DELIVERY ||--o{ SURVEY : triggers
    DELIVERY ||--o{ NCE : may_have
    USER ||--o{ NOTIFICATION : receives
    GUEST ||--o{ NOTIFICATION : receives_guest
