@startuml
title Seq 1 â€” Create Project, Delivery, Upload files, Send EmailToken

actor User
participant FE as Frontend
participant API
participant DB
participant MinIO
participant EmailService

User -> FE : open "Create Project" (name, client_email?)
FE -> API : POST /projects {name, client_email}
API -> DB : SELECT guest WHERE email=client_email
alt guest exists
  API -> DB : INSERT project(client_guest_id = guest.id)
else
  API -> DB : INSERT guest(email=client_email) -> guest_id
  API -> DB : INSERT project(client_guest_id = guest_id)
end
DB --> API : project_id
API --> FE : 201 Created {project_id}

User -> FE : create delivery + upload files
FE -> API : POST /deliveries {project_id, title, version} (JWT user)
API -> DB : INSERT delivery -> delivery_id
FE -> API : POST /files (multipart) with delivery_id
API -> MinIO : PUT file(s)
MinIO --> API : storage_key(s)
API -> DB : INSERT file rows (storage_key, filename, delivery_id)
API -> DB : INSERT EmailToken(token, email=client_email, purpose=view_delivery, resource_id=delivery_id, max_uses=1, expires_at=...)
API -> EmailService : sendEmail(client_email, url=https://app.lorem.com/.../t/<token>)
EmailService --> API : 200
API --> FE : 201 Delivery created + link sent

@enduml
